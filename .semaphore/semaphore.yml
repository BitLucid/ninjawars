version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: Setup
    task:
      jobs:
        - name: Install and Cache
          commands:
            - checkout
            - cache restore
            - yarn install
            - cache store
    dependencies: []
  - name: Test
    task:
      jobs:
        - name: test and build
          commands:
            - checkout
            - cache restore
            - yarn install
            - '# yarn test'
    dependencies:
      - Setup
  - name: PHP test and build
    dependencies:
      - Setup
    task:
      secrets:
        - name: Tchalvak AWS
      env_vars:
        - name: AWS_PROFILE
          value: tchalvak
        - name: GITHUB_ACCESS_TOKEN
          value: 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
      jobs:
        - name: PHP
          commands:
            - echo "install happens in the prologue step"
            - make build
            - ./composer.phar test
      prologue:
        commands:
          - checkout
          - sem-version php 8.2.2
          - cache restore
          - ./composer.phar config -g github-oauth.github.com $GITHUB_ACCESS_TOKEN
          - ./composer.phar install --prefer-dist
          - cache store
